{% extends "main/layout.html" %}

{% block title %}
    CollageVibs
{% endblock %}

{% block content %}
<wrapper class="wrapper"> 
  <div id="chat_window" class="chat-window"> 
    <div class="chat-header"> 
      <span id="online-count" class="online-count">3</span>online
    </div>

    <div id="chat_container" class="chat-container">
      <ul id="chat_messages" class="chat-messages">
    {% for chat in global_chat_messages reversed %}
    {% include "globalchat/global_chat_message.html" %}
    {% endfor %}
      </ul>
    </div>

    <div class="chat-footer">
      <div class="input-wrapper">
      <form
        id="chat_message_form"
        class="input-form"
        hx-ext="ws"
        ws-connect="/ws/globalchat/public-chat/"
        ws-send
        hx-swap="afterend"   
        hx-target="#chat_messages"  
        _="on htmx:wsAfterSend reset() me">

          {% csrf_token %}
          {{ form.message }}
      </form>
      </div>
    </div>
  </div>
</wrapper>

<script>
  // Animate and scroll when a new message arrives
  function handleNewMessage() {
    const messages = document.querySelectorAll(".chat-message");
    const lastMessage = messages[messages.length - 1];
    if (lastMessage && !lastMessage.classList.contains("appear")) {
      setTimeout(() => {
        lastMessage.classList.add("appear");
      }, 50);
    }
    setTimeout(() => {
      const chatContainer = document.getElementById('chat_container');
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }, 100);
  }

  // Listen for new message swaps from HTMX (initial load + OOB)
  document.body.addEventListener('htmx:afterSwap', handleNewMessage);
  document.body.addEventListener('htmx:oobAfterSwap', handleNewMessage);
</script>
{% endblock %}
