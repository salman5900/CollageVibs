{% extends "main/layout.html" %}

{% block title %}
    CollageVibs
{% endblock %}

{% block content %}
<style>
  .chat-messages li {
    opacity: 1;
    transform: translateY(0);
    transition: all 0.3s ease-in-out;
  }

  .chat-messages li.new-message {
    opacity: 0;
    transform: translateY(10px);
  }

  .chat-messages li.new-message.appear {
    opacity: 1;
    transform: translateY(0);
  }

  #first_unread_marker {
    height: 2px;
    background: linear-gradient(90deg, transparent, #166534, transparent);
    margin: 10px 0;
    position: relative;
  }

  #first_unread_marker::before {
    content: "New messages";
    position: absolute;
    left: 50%;
    top: -10px;
    transform: translateX(-50%);
    background: #166534;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7em;
    font-weight: bold;
  }
</style>

<div class="wrapper">
  <div id="chat_window" class="chat-window">
    <div class="chat-header">
      <span id="online-count" class="online-count"></span> online
    </div>

    <div id="chat_container" class="chat-container">
      <ul id="chat_messages" class="chat-messages">
        {% for chat in global_chat_messages %}
          {% if forloop.counter0 == first_unread_index %}
            <div id="first_unread_marker"></div>
          {% endif %}
          {% include "globalchat/global_chat_message.html" %}
        {% endfor %}
      </ul>
    </div>

    <div class="chat-footer">
      <div class="input-wrapper">
        <form id="chat_message_form" class="input-form">
          {% csrf_token %}
          {{ form.message }}
          <button type="submit" class="send-btn-mobile">âž¤</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const socket = new WebSocket('ws://' + window.location.host + '/ws/globalchat/public-chat/');

  socket.onmessage = function(event) {
    const incomingHtml = event.data.trim();
    if (!incomingHtml) return;

    if (incomingHtml.includes('id="online-count"')) {
      const onlineCountElement = document.getElementById('online-count');
      if (onlineCountElement) {
        onlineCountElement.outerHTML = incomingHtml;
      }
    } else {
      const container = document.getElementById('chat_messages');
      const temp = document.createElement('div');
      temp.innerHTML = incomingHtml;

      const newMessage = temp.firstElementChild;
      if (newMessage) {
        newMessage.classList.add('new-message');
        container.appendChild(newMessage);
        // Trigger animation
        setTimeout(() => newMessage.classList.add('appear'), 20);
      }

      const chatContainer = document.getElementById('chat_container');
      chatContainer.scrollTo({
        top: chatContainer.scrollHeight,
        behavior: 'smooth'
      });
    }
  };

  document.getElementById('chat_message_form').addEventListener('submit', function(e) {
    e.preventDefault();
    const messageInput = this.querySelector('input[name="message"]');
    if (!messageInput) return;

    const message = messageInput.value.trim();
    if (message) {
      socket.send(JSON.stringify({ 'message': message }));
      messageInput.value = '';
    }
  });

  window.addEventListener('load', () => {
    const chatContainer = document.getElementById('chat_container');
    const marker = document.getElementById('first_unread_marker');

    if (marker) {
      marker.scrollIntoView({ behavior: 'auto', block: 'center' });
    } else {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  });
</script>
{% endblock %}
