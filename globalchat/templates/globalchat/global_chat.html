{% extends "main/layout.html" %}

{% block title %}
    CollageVibs
{% endblock %}

{% block content %}
<wrapper class="wrapper">
  <div id="chat_window" class="chat-window">
    <div class="chat-header">
      <span id="online-count" class="online-count">3</span>online
    </div>

    <div id="chat_container" class="chat-container">
      <ul id="chat_messages" class="chat-messages">
    {% for chat in global_chat_messages reversed %}
    {% include "globalchat/global_chat_message.html" %}
    {% endfor %}
      </ul>
    </div>

    <div class="chat-footer">
      <div class="input-wrapper">
      <form id="chat_message_form" class="input-form"
            hx-ext="ws"
            ws-connect="/ws/globalchat/public-chat/"
            ws-send
            hx-swap="none"
            _="on htmx:wsAfterSend reset() me">
          {% csrf_token %}
          {{ form.message }}
      </form>
      </div>
    </div>
  </div>
</wrapper>
<script>
   // Function to scroll and animate
  function handleNewMessage() {
    // Add animation to the last message first
    const messages = document.querySelectorAll(".chat-message");
    const lastMessage = messages[messages.length - 1];
    if (lastMessage && !lastMessage.classList.contains("appear")) {
      // Trigger the appear animation
      setTimeout(() => {
        lastMessage.classList.add("appear");
      }, 50); // Small delay to ensure the element is rendered
    }

    // Scroll to bottom after animation starts
    setTimeout(() => {
      const chatContainer = document.getElementById('chat_container');
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }, 100);
  }

  // Listen for regular HTMX swaps (initial load, etc.)
  document.body.addEventListener('htmx:afterSwap', handleNewMessage);
  
  // Listen for WebSocket out-of-band swaps
  document.body.addEventListener('htmx:oobAfterSwap', handleNewMessage);
  
  // Alternative: Use MutationObserver to detect when new messages are added
  const chatMessages = document.getElementById('chat_messages');
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        // Check if a new message was added
        const addedNode = mutation.addedNodes[0];
        if (addedNode.nodeType === Node.ELEMENT_NODE && 
            (addedNode.classList.contains('message-sent') || 
             addedNode.classList.contains('message-received'))) {
          handleNewMessage();
        }
      }
    });
  });
  
  // Start observing
  observer.observe(chatMessages, { childList: true });
</script>


{% endblock %}