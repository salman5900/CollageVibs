{% extends "main/layout.html" %}
{% load custom_filters %}

{% block title %}
    CollageVibs
{% endblock %}

{% block content %}
<div class="cv-home-container">
  <!-- Global Chat Box -->
  <div onclick="goToGlobalChat()" class="cv-chat-box">
    <div id="global-unread" class="cv-unread-bubble" style="{% if unread_global > 0 %}display: block;{% else %}display: none;{% endif %}">{{ unread_global }}</div>
    <div class="cv-chat-content">
      <h1>Global Chat</h1>
      <p class="cv-chat-desc">Open space for all college students</p>
    </div>
    <div class="cv-online-count">{{ online_users_global }} online</div>
  </div>

  <!-- Club Chat Boxes -->
  {% for club in clubs %}
    {% with unread_count=unread_club_counts|get_item:club.id %}
    <div onclick="goToClubChat({{ club.id }})" class="cv-chat-box {{ club.gradient_class }}">
      <div id="club-unread-{{ club.id }}" class="cv-unread-bubble" style="{% if unread_count > 0 %}display: block;{% else %}display: none;{% endif %}">{{ unread_count }}</div>
      <div class="cv-chat-content">
        <h2>{{ club.name }}</h2>
        <p class="cv-chat-desc">{{ club.description|truncate_chars:150 }}</p>
      </div>
      <div class="cv-online-count">{{ online_users_club|get_item:club.id }} online</div>
    </div>
    {% endwith %}
  {% endfor %}

  <!-- Add New Club -->
  <div onclick="openCreateClubModal()" class="cv-chat-box cv-add-new-box">
    <i data-lucide="plus"></i>
  </div>
</div>

<script>
function goToGlobalChat() {
    sessionStorage.removeItem('global_unread');
    updateUnreadUI('global-unread', 0);
    window.location.href = "{% url 'globalchat:global_chat' %}";
}

function goToClubChat(clubId) {
    sessionStorage.removeItem(`club_unread_${clubId}`);
    updateUnreadUI(`club-unread-${clubId}`, 0);
    window.location.href = `/clubs/${clubId}`;
}

function openCreateClubModal(){
    window.location.href = "{% url 'clubs:create_club' %}";
}

lucide.createIcons();

const currentPath = window.location.pathname;

// Only run if not inside a chat room
if (!currentPath.includes('/globalchat') && !currentPath.includes('/clubs/')) {
  // GLOBAL CHAT SOCKET
  const globalSocket = new WebSocket('ws://' + window.location.host + '/ws/globalchat/public-chat/');
  let globalUnread = sessionStorage.getItem('global_unread') || {{ unread_global|default:0 }};
  updateUnreadUI('global-unread', globalUnread);

  globalSocket.onmessage = function (event) {
    const incoming = event.data.trim();
    if (!incoming.includes('online-count')) {
      globalUnread++;
      sessionStorage.setItem('global_unread', globalUnread);
      updateUnreadUI('global-unread', globalUnread);
    }
  };

  // CLUB CHAT SOCKETS
  {% for club in clubs %}
    const socket{{ club.id }} = new WebSocket('ws://' + window.location.host + `/ws/clubchat/{{ club.id }}/`);
    const clubKey{{ club.id }} = `club_unread_{{ club.id }}`;
    let count{{ club.id }} = sessionStorage.getItem(clubKey{{ club.id }}) || {{ unread_club_counts|get_item:club.id|default:0 }};

    updateUnreadUI(`club-unread-{{ club.id }}`, count{{ club.id }});

    socket{{ club.id }}.onmessage = function (event) {
      const data = JSON.parse(event.data);
      if (data.type === 'chat') {
        count{{ club.id }}++;
        sessionStorage.setItem(clubKey{{ club.id }}, count{{ club.id }});
        updateUnreadUI(`club-unread-{{ club.id }}`, count{{ club.id }});
      }
    };
  {% endfor %}

  // Helper to update the bubble UI
  function updateUnreadUI(id, count) {
    const el = document.getElementById(id);
    if (el) {
      if (count > 0) {
        el.style.display = 'block';
        el.innerText = count;
      } else {
        el.style.display = 'none';
      }
    }
  }
}

// Reset unread count if already inside chat
if (currentPath.includes('/globalchat')) {
  sessionStorage.removeItem('global_unread');
} else if (currentPath.includes('/clubs/')) {
  const clubId = currentPath.split('/clubs/')[1];
  if (clubId) sessionStorage.removeItem(`club_unread_${clubId}`);
}
</script>
{% endblock %}
